import logging
import os
import sys

from typing import Optional, Set
from opentelemetry.sdk.trace import SpanProcessor
from opentelemetry.sdk.trace.export import SpanExporter
from opentelemetry.sdk.metrics.export import MetricExporter
from opentelemetry.sdk.resources import SERVICE_NAME
from opentelemetry.propagators.textmap import TextMapPropagator
from opentelemetry.util.re import parse_env_headers

from apmplus_server.sdk.logs.logs import LogsWrapper
from apmplus_server.sdk.metrics.metrics import MetricsWrapper
from apmplus_server.sdk.instruments import Instruments
from apmplus_server.sdk.config import (
    is_content_tracing_enabled,
    is_tracing_enabled,
    is_metrics_enabled,
    is_logs_enabled
)
from apmplus_server.sdk.tracing import (
    TracerWrapper,
    set_association_properties,
)
from typing import Dict


class Initializer:
    __tracer_wrapper: TracerWrapper

    @staticmethod
    def init(
        app_name: Optional[str] = sys.argv[0],
        api_endpoint: str = "http://apmplus-cn-beijing.volces.com:4317",
        headers: Dict[str, str] = {},
        disable_batch=False,
        span_exporter: SpanExporter = None,
        metrics_exporter: MetricExporter = None,
        metrics_headers: Dict[str, str] = {},
        logs_exporter: MetricExporter = None,
        logs_headers: Dict[str, str] = {},
        span_processor: SpanProcessor = None,
        propagator: TextMapPropagator = None,
        resource_attributes: dict = {},
        system_metrics: str = "true",
        instrumentors: Optional[Set[Instruments]] = None,

    ) -> None:
        ## log
        # Telemetry()

        api_endpoint = api_endpoint or os.getenv("APMPLUS_TRACE_ENDPOINT")
        if not is_tracing_enabled():
            logging.info("Tracing is disabled")
            return

        enable_content_tracing = is_content_tracing_enabled()

        if span_exporter or span_processor:
            logging.info("APMPlus Tracer exporting traces to a custom exporter")

        headers = os.getenv("APMPLUS_TRACE_HEADERS") or headers

        if isinstance(headers, str):
            headers = parse_env_headers(headers)

        if not span_exporter and not span_processor and headers:
            logging.warning( f"APMPlus exporting traces to {api_endpoint}, authenticating with custom headers")


        # Tracer init
        resource_attributes.update({SERVICE_NAME: app_name})
        resource_attributes.update({"service_type_llm": "true"})
        TracerWrapper.set_static_params(
            resource_attributes, enable_content_tracing, api_endpoint, headers
        )
        Initializer.__tracer_wrapper = TracerWrapper(
            disable_batch=disable_batch,
            processor=span_processor,
            propagator=propagator,
            exporter=span_exporter,
            instruments=instrumentors,
            system_metrics=system_metrics
        )

        if not is_metrics_enabled():
            logging.info("Metrics is disabled")
        else:
            logging.info("Metrics is enabled")
            # metrics
            if metrics_exporter:
                logging.info("apmplus exporting metrics to a custom exporter")

            metrics_endpoint = os.getenv("APMPLUS_METRICS_ENDPOINT", api_endpoint)
            metrics_headers = os.getenv("APMPLUS_METRICS_HEADERS") or metrics_headers or headers

            if isinstance(metrics_headers, str):
                metrics_headers = parse_env_headers(metrics_headers)
            logging.info(f"APMPlus exporting metrics to {metrics_endpoint}, header: {metrics_headers}")
            MetricsWrapper.set_static_params(
                resource_attributes, metrics_endpoint, metrics_headers
            )
            Initializer.__metrics_wrapper = MetricsWrapper(exporter=metrics_exporter)

        # logs
        if not is_logs_enabled():
            logging.info("Logs is disabled")
            return
        if logs_exporter:
            logging.info("apmplus exporting logs to a custom exporter")

        logs_headers = os.getenv("APMPLUS_LOGS_HEADERS") or logs_headers or headers
        logs_endpoint = os.getenv("APMPLUS_LOGS_ENDPOINT", api_endpoint)

        if isinstance(logs_headers, str):
            logs_headers = parse_env_headers(logs_headers)
        logging.info(f"APMPlus exporting logs to {logs_endpoint}, header: {logs_headers}")

        LogsWrapper.set_static_params(
            resource_attributes, logs_endpoint, logs_headers
        )
        Initializer.__logs_wrapper = LogsWrapper(exporter=logs_exporter)
        logging.warning("Warn: APMPlus Tracer init success")


    def set_association_properties(properties: dict) -> None:
        set_association_properties(properties)

