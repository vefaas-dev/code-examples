import logging

from opentelemetry import _logs
from opentelemetry.sdk.resources import Resource

from opentelemetry.sdk._logs import LoggerProvider, LoggingHandler
from opentelemetry.sdk._logs.export import LogExporter
from opentelemetry.sdk._logs.export import BatchLogRecordProcessor

from opentelemetry.exporter.otlp.proto.grpc._log_exporter import (
    OTLPLogExporter as GRPCExporter
)

from opentelemetry.exporter.otlp.proto.http._log_exporter import (
    OTLPLogExporter as HTTPExporter
)

from typing import Dict


class LogsWrapper(object):
    resource_attributes: dict = {}
    endpoint: str = None
    # if it needs headers?
    headers: Dict[str, str] = {}

    def __new__(cls, exporter: LogExporter = None) -> "LogsWrapper":
        if not hasattr(cls, "instance"):
            obj = cls.instance = super(LogsWrapper, cls).__new__(cls)
            if not LogsWrapper.endpoint:
                return obj

            obj.__logs_exporter: LogExporter = (
                exporter if exporter
                else init_logs_exporter(
                    LogsWrapper.endpoint, LogsWrapper.headers
                )
            )

            obj.__logs_provider: LoggerProvider = init_logs_provider(obj.__logs_exporter,
                                                                          LogsWrapper.resource_attributes)

            handler = LoggingHandler(level=logging.NOTSET, logger_provider=obj.__logs_provider)
            # Attach OTLP handler to root logger
            logging.getLogger().addHandler(handler)

        return cls.instance

    @staticmethod
    def set_static_params(
            resource_attributes: dict,
            endpoint: str,
            headers: Dict[str, str],
    ) -> None:
        LogsWrapper.resource_attributes = resource_attributes
        LogsWrapper.endpoint = endpoint
        LogsWrapper.headers = headers


def init_logs_exporter(endpoint: str, headers: Dict[str, str]) -> LogExporter:
    if "80" in endpoint.lower():
        return HTTPExporter(endpoint=endpoint, headers=headers)
    else:
        return GRPCExporter(endpoint=endpoint, headers=headers)


def init_logs_provider(exporter: LogExporter,
                          resource_attributes: dict = None) -> LoggerProvider:
    resource = Resource.create(resource_attributes) if resource_attributes else Resource.create()

    provider = LoggerProvider(resource=resource)
    provider.add_log_record_processor(BatchLogRecordProcessor(exporter))

    _logs.set_logger_provider(provider)

    return provider
